{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "managedClusters_aksdemo1_name": {
            "defaultValue": "aksdemo1",
            "type": "string"
        },
        "location": {
            "defaultValue": "eastus",
            "type": "string"
        },
        "aksSku": {
            "defaultValue": "Free",
            "type": "string"
        },
        "aksVersion": {
            "defaultValue": "1.20.9",
            "type": "string"
        },
        "aksPoolName": {
            "defaultValue": "agentpool",
            "type": "string"
        },
    //    "aksPoolCount": {
    //        "defaultValue": "0",
    //        "type": "int"
    //    },
        "agentpool_managedid_name": {
            "defaultValue": "aksdemo1-agentpool",
            "type": "string"
        },
        "aksPoolVmSize": {
            "defaultValue": "Standard_DS2_v2",
            "type": "string"
        },
        "aksPoolOsDiskSize": {
            "defaultValue": "128",
            "type": "string"
        },
        "aksPoolOsDiskType": {
            "defaultValue": "Managed",
            "type": "string"
        },
        "aksPoolMode": {
            "defaultValue": "System",
            "type": "string"
        },
        "aksPoolOsType": {
            "defaultValue": "Linux",
            "type": "string"
        },
        "aksPoolOsSku": {
            "defaultValue": "Ubuntu",
            "type": "string"
        },
        "aksWinUserName": {
            "defaultValue": "azureuser",
            "type": "string"
        },
        "aks_publicIP_name": {
            "defaultValue": "aks_publicIP",
            "type": "string"
        },
        "aksManagedRgName": {
            "defaultValue": "aksManagedRg",
            "type": "string"
        },
        "envName": {
            "type": "string",
            "defaultValue": "dev",
            "metadata": {
            "description": "Name of the virtual network"
            }
          },
          "application": {
            "type": "string",
            "defaultValue": "EUS",
            "metadata": {
              "description": "Name of the virtual network"
            }
          },
          "vnetAddressPrefix": {
            "type": "string",
            "defaultValue": "172.16.0.0/16",
            "metadata": {
              "description": "Name of the virtual network"
            }
          },
          "subnetAddressPrefix": {
            "type": "string",
            "defaultValue": "172.240.2.0/16",
            "metadata": {
              "description": "Pricing Tier of app service plan"
            }
          },
        "virtualNetworks_NetworkWatcherRG_vnet_externalid": {
            "defaultValue": "/subscriptions/d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c/resourceGroups/NetworkWatcherRG/providers/Microsoft.Network/virtualNetworks/NetworkWatcherRG-vnet",
            "type": "string"
        },
        "workspaces_DefaultWorkspace_d468f60e_bc7a_4a2b_ab0f_bf1e1ac6284c_EUS_externalid": {
            "defaultValue": "/subscriptions/d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c/resourceGroups/DefaultResourceGroup-EUS/providers/Microsoft.OperationalInsights/workspaces/DefaultWorkspace-d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c-EUS",
            "type": "string"
        },
        "publicIPAddresses_9368cdb3_3345_4b9c_93ba_bd00827888f1_externalid": {
            "defaultValue": "/subscriptions/d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c/resourceGroups/MC_NetworkWatcherRG_aksdemo1_eastus/providers/Microsoft.Network/publicIPAddresses/9368cdb3-3345-4b9c-93ba-bd00827888f1",
            "type": "string"
        },
        "userAssignedIdentities_aksdemo1_agentpool_externalid": {
            "defaultValue": "/subscriptions/d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c/resourceGroups/MC_NetworkWatcherRG_aksdemo1_eastus/providers/Microsoft.ManagedIdentity/userAssignedIdentities/aksdemo1-agentpool",
            "type": "string"
        }
    },
    "variables": { 
        "vnet": "[concat('vnet','-', 'EUS', '-',parameters('envName'),'-',parameters('application'))]",
        "subnet": {
            "frontend": "[concat('frontendSub-', 'EUS','-', parameters('envName'),'-',parameters('application'))]"
        },
        "subnetName": {
            "frontend": "[concat(variables('vnet'), '/', variables('subnet').frontend)]"
        },
        "networkSecurityGroupName": {
            "frontend": "[concat('frontendNSG','-','EUS','-', parameters('envName'),'-',parameters('application'))]"
        }
      },
    "resources": [
        {
            "comments": "Default Network Security Group for template",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-08-01",
            "tags": {
              "Project": "Vprofile",
              "Environment": "[parameters('envName')]"
            },
            "name": "[variables('networkSecurityGroupName').frontend]",
            "location": "[parameters('location')]",
            "properties": {
              "securityRules": [
                {
                  "name": "default-allow-3389",
                  "properties": {
                    "priority": 1000,
                    "access": "Allow",
                    "direction": "Inbound",
                    "destinationPortRange": "3389",
                    "protocol": "Tcp",
                    "sourceAddressPrefix": "*",
                    "sourcePortRange": "*",
                    "destinationAddressPrefix": "*"
                  }
                }
              ]
            }
          },
          {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2017-06-01",
            "name": "[variables('vnet')]",
            "location": "[parameters('location')]",
            "dependsOn": ["[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName').frontend)]"],
            "tags": {
              "Project": "Vprofile",
              "Environment": "[parameters('envName')]"
            },
            "properties": {
              "addressSpace": {
                "addressPrefixes": [
                  "[parameters('vnetAddressPrefix')]"
                ]
              }
            }
          },
          {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2017-06-01",
            "name": "[variables('subnetName').frontend]",
            "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnet'))]"
            ],
                 "properties": {
              "addressPrefix": "[parameters('subnetAddressPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName').frontend)]"
              }
            }
          },
          {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "2018-11-30",
            "name": "[parameters('agentpool_managedid_name')]",
            "location": "eastus"
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2020-11-01",
            "name": "[parameters('aks_publicIP_name')]",
            "location": "eastus",
            "tags": {
                "type": "aks-slb-managed-outbound-ip"
            },
            "sku": {
                "name": "Standard",
                "tier": "Regional"
            },
            "zones": [
                "2",
                "3",
                "1"
            ],
            "properties": {
                "ipAddress": "20.62.233.0",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 30,
                "ipTags": []
            }
        },
        {
            "type": "Microsoft.ContainerService/managedClusters",
            "apiVersion": "2021-07-01",
            "name": "[parameters('managedClusters_aksdemo1_name')]",
            "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnet'))]"
                    //    "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('subnetName').frontend)]"
            ],
            "location": "[parameters('location')]",
            "sku": {
                "name": "Basic",
                "tier": "[parameters('aksSku')]"
            },
            "identity": {
                "principalId": null,
                "tenantId": null,
                "type": "SystemAssigned"
            },
            "properties": {
                "kubernetesVersion": "[parameters('aksVersion')]",
                "dnsPrefix": "[concat(parameters('managedClusters_aksdemo1_name'), '-dns')]",
                "agentPoolProfiles": [
                    {
                        "name": "[parameters('aksPoolName')]",
                        "count": 1,
                        "vmSize": "[parameters('aksPoolVmSize')]",
                        "osDiskSizeGB": 128,
                        "osDiskType": "[parameters('aksPoolOsDiskType')]",
                        "kubeletDiskType": "OS",
                        "vnetSubnetID": "/subscriptions/d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c/resourceGroups/AKS-RG/providers/Microsoft.Network/virtualNetworks/vnet-EUS-dev-EUS/subnets/frontendSub-EUS-dev-EUS",
                        "maxPods": 110,
                        "type": "VirtualMachineScaleSets",
                        "availabilityZones": [
                            "1",
                            "2",
                            "3"
                        ],
                        "enableAutoScaling": false,
                        "orchestratorVersion": "1.20.9",
                        "mode": "[parameters('aksPoolMode')]",
                        "osType": "[parameters('aksPoolOsType')]",
                        "osSKU": "[parameters('aksPoolOsSku')]Ubuntu",
                        "enableFIPS": false
                    }
                ],
                "windowsProfile": {
                    "adminUsername": "[parameters('aksWinUserName')]",
                    "adminPassword": "anglo@123",
                    "enableCSIProxy": true
                },
                "servicePrincipalProfile": {
                    "clientId": "msi"
                },
                "addonProfiles": {
                    "azurepolicy": {
                        "enabled": false
                    },
                    "httpApplicationRouting": {
                        "enabled": false
                    },
                    "omsAgent": {
                        "enabled": true,
                        "config": {
                            "logAnalyticsWorkspaceResourceID": "[parameters('workspaces_DefaultWorkspace_d468f60e_bc7a_4a2b_ab0f_bf1e1ac6284c_EUS_externalid')]"
                        }
                    }
                },
                "nodeResourceGroup": "[parameters('aksManagedRgName')]",
                "enableRBAC": true,
                "networkProfile": {
                    "networkPlugin": "azure",
                    "networkPolicy": "azure",
                    "loadBalancerSku": "Standard",
                    "loadBalancerProfile": {
                        "managedOutboundIPs": {
                            "count": 1
                        },
                        "effectiveOutboundIPs": [
                            {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('aks_publicIP_name'))]"
                            }
                        ]
                    },
                    "serviceCidr": "172.16.0.0/16",
                    "dnsServiceIP": "172.16.0.10",
                    "dockerBridgeCidr": "172.17.0.1/16",
                    "outboundType": "loadBalancer"
                },
                "apiServerAccessProfile": {
                    "enablePrivateCluster": false
                },
                "identityProfile": {
                    "kubeletidentity": {
                        "kubeResourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('agentpool_managedid_name'))]",
                        "clientId": "51a05f2d-60dc-4790-b2ee-3f1bd4f8083c",
                        "objectId": "725f6857-7647-4239-bcb6-b50fb3e562c0"
                    }
                }
            }
        },
        {
            "type": "Microsoft.ContainerService/managedClusters/agentPools",
            "apiVersion": "2021-07-01",
            "name": "[concat(parameters('managedClusters_aksdemo1_name'), '/agentpool')]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('managedClusters_aksdemo1_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnet'))]"
            ],
            "properties": {
                "count": 0,
                "vmSize": "Standard_DS2_v2",
                "osDiskSizeGB": 128,
                "osDiskType": "Managed",
                "kubeletDiskType": "OS",
                "vnetSubnetID": "/subscriptions/d468f60e-bc7a-4a2b-ab0f-bf1e1ac6284c/resourceGroups/AKS-RG/providers/Microsoft.Network/virtualNetworks/vnet-EUS-dev-EUS/subnets/frontendSub-EUS-dev-EUS",
              //  "vnetSubnetID": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('subnetName'))]",
                "maxPods": 110,
                "type": "VirtualMachineScaleSets",
                "availabilityZones": [
                    "1",
                    "2",
                    "3"
                ],
                "enableAutoScaling": false,
                "orchestratorVersion": "1.20.9",
                "mode": "System",
                "osType": "Linux",
                "osSKU": "Ubuntu",
                "enableFIPS": false
            }
        }
    ]
}