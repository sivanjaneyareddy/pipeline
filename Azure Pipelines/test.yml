trigger:
- none

pool:
  vmImage: 'windows-latest'

variables:
  - name: klodb
    value: KLODB
  - name: klousername
    value: KLOUsername
  - name: klopassword
    value: KLOPassword

resources:
 repositories:
     - repository: Vprofile
       type: git
       name: Java Project/Vprofile

parameters:
- name: Environments
  displayName: ENVIRONMENTS
  values:
      - QA
      - KLO
      - STG

stages:
    - stage: BUILD
      jobs:
          - job: build
            steps:
              - checkout: "Vprofile"
              - task: PowerShell@2
                inputs:
                  targetType: 'inline'
                  script: |
                    $Config_path = "$(System.DefaultWorkingDirectory)/src/main/resources/application.properties"
                    $Contents = get-content $Config_path 
                    $ChangedValues = $Contents -replace "dbservername", "${{variables.klodb}}"
                    $ChangedValues = $ChangedValues -replace "dbusername", "${{variables.klousername}}"
                    $ChangedValues = $ChangedValues -replace "dbpassword", "${{variables.klopassword}}"
                    $ChangedValues > $Config_path
              - task: Maven@3
                inputs:
                  mavenPomFile: 'pom.xml'
                  publishJUnitResults: true
                  testResultsFiles: '**/surefire-reports/TEST-*.xml'
                  javaHomeOption: 'JDKVersion'
                  mavenVersionOption: 'Default'
                  mavenAuthenticateFeed: false
                  effectivePomSkip: false
                  sonarQubeRunAnalysis: false
                  checkStyleRunAnalysis: true
                  pmdRunAnalysis: true
                  findBugsRunAnalysis: true

              - task: CopyFiles@2
                inputs:
                  SourceFolder: '$(System.DefaultWorkingDirectory)'
                  Contents:  |
                    src\main\resources\application.properties
                    target\*.war
                  TargetFolder: '$(Build.ArtifactStagingDirectory)'
              - task: PublishBuildArtifacts@1
                inputs:
                  PathtoPublish: '$(Build.ArtifactStagingDirectory)'
                  ArtifactName: 'drop'
                  publishLocation: 'Container'
              